<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeuEstoque - Gestão de Estoque Empresarial</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 0;
        }

        h1, h2 {
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .form-section, .product-list, .alerts {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-section input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .form-section button {
            background-color: #3498db;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .form-section button:hover {
            background-color: #2980b9;
        }

        .product-list ul {
            list-style: none;
            padding: 0;
        }

        .product-list li {
            padding: 10px;
            background-color: #ecf0f1;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .alerts .alert-item {
            background-color: #e74c3c;
            color: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .alerts .alert-item.success {
            background-color: #2ecc71;
        }

        .alerts .alert-item.warning {
            background-color: #f39c12;
        }

        .form-error {
            color: red;
            font-size: 0.9em;
        }

        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .form-section input, .form-section button {
                width: 100%;
            }
        }
    </style>
    <script>
        async function listarProdutos() {
            try {
                const response = await fetch('/api/produtos/listar');
                const data = await response.json();

                let lista = document.getElementById("produtos-lista");
                lista.innerHTML = ""; // Limpa a lista antes de atualizar
                const alertasVencimento = document.getElementById("alertas-vencimento");
                const alertasQuantidade = document.getElementById("alertas-quantidade");
                alertasVencimento.innerHTML = "";
                alertasQuantidade.innerHTML = "";

                data.forEach(produto => {
                    let item = document.createElement("li");
                    item.textContent = `${produto.nome} - Quantidade: ${produto.quantidade} - Validade: ${produto.validade} - Lote: ${produto.lote}`;
                    lista.appendChild(item);

                    // Alertas de vencimento
                    const validade = new Date(produto.validade);
                    const hoje = new Date();
                    const diff = validade - hoje;
                    const diasRestantes = Math.floor(diff / (1000 * 60 * 60 * 24));

                    if (diasRestantes <= 7 && diasRestantes >= 0) {
                        const alertaVencimento = document.createElement("div");
                        alertaVencimento.classList.add("alert-item");
                        alertaVencimento.textContent = `${produto.nome} (Lote: ${produto.lote}) está prestes a vencer em ${diasRestantes} dias.`;
                        alertasVencimento.appendChild(alertaVencimento);
                    }

                    // Alertas de quantidade
                    const min = parseInt(produto.quantidadeMinima);
                    const max = parseInt(produto.quantidadeMaxima);
                    const atual = parseInt(produto.quantidade);

                    if (!isNaN(min) && atual < min) {
                        const alertaQuantidade = document.createElement("div");
                        alertaQuantidade.classList.add("alert-item", "warning");
                        alertaQuantidade.textContent = `⚠ ${produto.nome} (Lote: ${produto.lote}) está abaixo da quantidade mínima (${atual} < ${min})`;
                        alertasQuantidade.appendChild(alertaQuantidade);
                    }

                    if (!isNaN(max) && atual > max) {
                        const alertaQuantidade = document.createElement("div");
                        alertaQuantidade.classList.add("alert-item", "warning");
                        alertaQuantidade.textContent = `⚠ ${produto.nome} (Lote: ${produto.lote}) excedeu a quantidade máxima (${atual} > ${max})`;
                        alertasQuantidade.appendChild(alertaQuantidade);
                    }
                });

                if (alertasVencimento.innerHTML === "") {
                    alertasVencimento.innerHTML = "<p class='alert-item success'>✅ Nenhum produto está prestes a vencer.</p>";
                }

                if (alertasQuantidade.innerHTML === "") {
                    alertasQuantidade.innerHTML = "<p class='alert-item success'>✅ Todos os produtos estão dentro dos limites de estoque.</p>";
                }
            } catch (error) {
                console.error("Erro ao listar produtos: ", error);
            }
        }

        async function adicionarProduto() {
            const nome = document.getElementById("nomeProduto").value;
            const quantidade = document.getElementById("quantidade").value;
            const validade = document.getElementById("validade").value;
            const dataCompra = document.getElementById("dataCompra").value;
            const lote = document.getElementById("lote").value;
            const quantidadeMinima = document.getElementById("quantidadeMinima").value;
            const quantidadeMaxima = document.getElementById("quantidadeMaxima").value;

            let mensagensErro = [];
            if (!nome) mensagensErro.push("Nome do produto é obrigatório.");
            if (!quantidade) mensagensErro.push("Quantidade é obrigatória.");
            if (!validade) mensagensErro.push("Data de validade é obrigatória.");
            if (!dataCompra) mensagensErro.push("Data de compra é obrigatória.");
            if (!lote) mensagensErro.push("Lote é obrigatório.");
            if (!quantidadeMinima) mensagensErro.push("Quantidade mínima é obrigatória.");
            if (!quantidadeMaxima) mensagensErro.push("Quantidade máxima é obrigatória.");

            if (mensagensErro.length > 0) {
                document.getElementById("error-messages").innerHTML = "<ul class='form-error'>" + mensagensErro.map(msg => `<li>${msg}</li>`).join("") + "</ul>";
                return;
            }

            try {
                const response = await fetch('/api/produtos/adicionar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome, quantidade, validade, dataCompra, lote, quantidadeMinima, quantidadeMaxima
                    })
                });

                if (response.ok) {
                    listarProdutos(); // Atualiza a lista de produtos
                } else {
                    alert("Erro ao adicionar produto.");
                }
            } catch (error) {
                console.error("Erro ao adicionar produto: ", error);
            }
        }

        // Função para cadastrar a saída de produto
        async function cadastrarSaida() {
            const nomeProduto = document.getElementById("nomeProdutoSaida").value;
            const quantidadeSaida = document.getElementById("quantidadeSaida").value;
            const lote = document.getElementById("loteSaida").value;

            let mensagensErro = [];
            if (!nomeProduto) mensagensErro.push("Nome do produto é obrigatório.");
            if (!quantidadeSaida) mensagensErro.push("Quantidade de saída é obrigatória.");
            if (!lote) mensagensErro.push("Lote é obrigatório.");

            if (mensagensErro.length > 0) {
                document.getElementById("error-messages").innerHTML = "<ul class='form-error'>" + mensagensErro.map(msg => `<li>${msg}</li>`).join("") + "</ul>";
                return;
            }

            try {
                const response = await fetch('/api/produtos/saida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nomeProduto, quantidadeSaida, lote
                    })
                });

                if (response.ok) {
                    listarProdutos(); // Atualiza a lista de produtos
                    alert("Saída registrada com sucesso.");
                } else {
                    alert("Erro ao registrar saída.");
                }
            } catch (error) {
                console.error("Erro ao cadastrar saída: ", error);
            }
        }

        window.onload = function() {
            listarProdutos();
        };
    </script>
</head>
<body>
<div class="container">
    <h1>MeuEstoque - Gestão de Estoque Empresarial</h1>

    <div class="form-section">
        <h2>Adicionar Produto</h2>
        <div id="error-messages"></div>
        <input type="text" id="nomeProduto" placeholder="Nome do Produto" required>
        <input type="number" id="quantidade" placeholder="Quantidade" required>
        <input type="date" id="validade" placeholder="Data de Validade" required>
        <input type="text" id="lote" placeholder="Lote" required>
        <input type="number" id="quantidadeMinima" placeholder="Quantidade Mínima" required>
        <input type="number" id="quantidadeMaxima" placeholder="Quantidade Máxima" required>
        <button onclick="adicionarProduto()">Adicionar Produto</button>
    </div>

    <div class="form-section">
        <h2>Cadastrar Saída</h2>
        <input type="text" id="nomeProdutoSaida" placeholder="Nome do Produto" required>
        <input type="number" id="quantidadeSaida" placeholder="Quantidade de Saída" required>
        <input type="text" id="loteSaida" placeholder="Lote do Produto" required>
        <button onclick="cadastrarSaida()">Cadastrar Saída</button>
    </div>

    <div class="product-list">
        <h2>Produtos no Estoque</h2>
        <ul id="produtos-lista"></ul>
    </div>

    <div class="alerts">
        <div class="section">
            <h2>Alertas de Vencimento</h2>
            <div id="alertas-vencimento" class="alertas"></div>
        </div>
        <div class="section">
            <h2>Alertas de Quantidade</h2>
            <div id="alertas-quantidade" class="alertas"></div>
        </div>
    </div>
</div>
</body>
</html>
