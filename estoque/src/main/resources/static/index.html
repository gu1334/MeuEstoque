<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeuEstoque - Gestão de Estoque </title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --text-color: #2c3e50;
            --bg-color: #f9f9f9;
            --card-bg-color: #ffffff;
            --border-color: #ddd;
            --light-bg-color: #ecf0f1;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f6f6f6; /* Alterado para um tom de preto suave */
            margin: 0;
            padding: 0;
            line-height: 1.6;
            color: #000000; /* Alterado para uma cor de texto mais clara para contrastar */
        }

        h1, h2 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 25px;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }

        .form-section, .product-list, .alerts {
            background-color: var(--card-bg-color);
            border-radius: 10px; /* Bordas mais arredondadas */
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1); /* Sombra mais suave */
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-section input[type="text"],
        .form-section input[type="number"],
        .form-section input[type="date"] {
            width: calc(100% - 22px); /* Ajuste para padding e borda */
            padding: 11px;
            margin: 0; /* Remove margem desnecessária */
            border-radius: 6px; /* Bordas mais arredondadas */
            border: 1px solid var(--border-color);
            box-sizing: border-box; /* Garante que padding e borda não aumentem o tamanho */
            font-size: 1rem;
        }

        .form-section button {
            background-color: var(--primary-color);
            color: #fff;
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            transition: background-color 0.3s ease; /* Transição suave */
            width: 100%;
            margin-top: 10px;
        }

        .form-section button:hover {
            background-color: #2980b9; /* Tom mais escuro no hover */
        }

        .product-list ul {
            list-style: none;
            padding: 0;
        }

        .product-list li {
            padding: 15px;
            background-color: var(--light-bg-color);
            margin-bottom: 10px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; /* Permite quebrar linha em telas menores */
            font-size: 0.95rem;
        }

        .product-list li span {
            margin-right: 10px; /* Espaçamento entre os itens */
        }

        .alerts .alert-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .alerts .alert-item.danger {
            background-color: var(--danger-color);
            color: white;
        }

        .alerts .alert-item.success {
            background-color: var(--secondary-color);
            color: white;
        }

        .alerts .alert-item.warning {
            background-color: var(--warning-color);
            color: white;
        }

        .form-error {
            color: var(--danger-color);
            font-size: 0.9em;
            margin-top: -10px;
            margin-bottom: 15px;
            list-style-type: none; /* Remove bolinhas da lista de erros */
            padding-left: 0;
        }

        .form-feedback {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
        }

        .form-feedback.success {
            background-color: #d4edda; /* Fundo verde claro */
            color: #155724; /* Texto verde escuro */
            border: 1px solid #c3e6cb;
        }

        .form-feedback.error {
            background-color: #f8d7da; /* Fundo vermelho claro */
            color: #721c24; /* Texto vermelho escuro */
            border: 1px solid #f5c6cb;
        }

        /* Responsividade */
        @media screen and (max-width: 768px) {
            .container {
                padding: 15px;
            }
            .form-section input[type="text"],
            .form-section input[type="number"],
            .form-section input[type="date"],
            .form-section button {
                width: 100%;
            }
            .product-list li {
                flex-direction: column;
                align-items: flex-start;
            }
            .product-list li span {
                margin-bottom: 5px;
            }
        }
    </style>
    <script>
        // Função auxiliar para exibir feedback na interface
        function showFeedback(elementId, message, type) {
            const feedbackElement = document.getElementById(elementId);
            feedbackElement.textContent = message;
            feedbackElement.className = `form-feedback ${type}`;
            feedbackElement.style.display = 'block';

            // Oculta a mensagem após alguns segundos
            setTimeout(() => {
                feedbackElement.style.display = 'none';
                feedbackElement.textContent = '';
                feedbackElement.className = '';
            }, 3000);
        }

        // Função para limpar os campos do formulário
        function clearFormFields(formId) {
            const form = document.getElementById(formId);
            const inputs = form.querySelectorAll('input[type="text"], input[type="number"], input[type="date"]');
            inputs.forEach(input => input.value = '');
        }

        async function listarProdutos() {
            try {
                const response = await fetch('/api/produtos/listar');
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`Erro na API ao listar produtos: ${response.status} - ${response.statusText}`, errorText);
                    throw new Error(`Erro ao carregar produtos: ${errorText}`);
                }
                const data = await response.json();

                let lista = document.getElementById("produtos-lista");
                lista.innerHTML = "";

                const alertasVencimento = document.getElementById("alertas-vencimento");
                const alertasQuantidade = document.getElementById("alertas-quantidade");
                alertasVencimento.innerHTML = "";
                alertasQuantidade.innerHTML = "";

                if (data.length === 0) {
                    lista.innerHTML = "<li>Nenhum produto cadastrado.</li>";
                }

                let produtosParaVencer = 0;
                let produtosComProblemaQuantidade = 0;

                data.forEach(produto => {
                    let item = document.createElement("li");
                    // O backend Spring Boot retorna LocalDate como um array [ano, mes, dia] por padrão em JSON
                    // Precisamos reconstruir a data corretamente para o JavaScript para exibição e cálculos.
                    const validadeDateObject = Array.isArray(produto.validade)
                        ? new Date(produto.validade[0], produto.validade[1] - 1, produto.validade[2])
                        : new Date(produto.validade); // fallback caso o formato seja string 'YYYY-MM-DD'

                    // Formata a data para exibição no formato DD/MM/YYYY
                    const validadeFormatada = validadeDateObject.toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });

                    item.innerHTML = `
                        <span><strong>Produto:</strong> ${produto.nome}</span>
                        <span><strong>Quantidade:</strong> ${produto.quantidade}</span>
                        <span><strong>Validade:</strong> ${validadeFormatada}</span>
                        <span><strong>Lote:</strong> ${produto.lote}</span>
                    `;
                    lista.appendChild(item);

                    // Alertas de vencimento - A data já é um objeto Date para cálculo
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0); // Zera horas para comparação de dias

                    const diffTime = validadeDateObject.getTime() - hoje.getTime();
                    const diasRestantes = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Arredonda para cima para incluir o dia atual

                    if (diasRestantes <= 7 && diasRestantes >= 0) { // Alerta para produtos que vencem em 7 dias ou menos (incluindo hoje)
                        const alertaVencimento = document.createElement("div");
                        alertaVencimento.classList.add("alert-item", "danger");
                        alertaVencimento.innerHTML = `<strong>Vencimento:</strong> ${produto.nome} (Lote: ${produto.lote}) está prestes a vencer em ${diasRestantes} dias.`;
                        alertasVencimento.appendChild(alertaVencimento);
                        produtosParaVencer++;
                    } else if (diasRestantes < 0) { // Produto já vencido
                        const alertaVencimento = document.createElement("div");
                        alertaVencimento.classList.add("alert-item", "danger");
                        alertaVencimento.innerHTML = `<strong>Vencido:</strong> ${produto.nome} (Lote: ${produto.lote}) venceu há ${Math.abs(diasRestantes)} dias.`;
                        alertasVencimento.appendChild(alertaVencimento);
                        produtosParaVencer++;
                    }

                    // Alertas de quantidade
                    const min = parseInt(produto.quantidadeMinima);
                    const max = parseInt(produto.quantidadeMaxima);
                    const atual = parseInt(produto.quantidade);

                    if (isNaN(min) || isNaN(max) || isNaN(atual)) {
                        console.warn(`Dados inválidos para quantidade/limites do produto: ${produto.nome}`);
                    } else {
                        if (atual < min) {
                            const alertaQuantidade = document.createElement("div");
                            alertaQuantidade.classList.add("alert-item", "warning");
                            alertaQuantidade.innerHTML = `<strong>Abaixo do Mínimo:</strong> ${produto.nome} (Lote: ${produto.lote}) está abaixo da quantidade mínima (${atual} < ${min})`;
                            alertasQuantidade.appendChild(alertaQuantidade);
                            produtosComProblemaQuantidade++;
                        } else if (atual > max) {
                            const alertaQuantidade = document.createElement("div");
                            alertaQuantidade.classList.add("alert-item", "warning");
                            alertaQuantidade.innerHTML = `<strong>Acima do Máximo:</strong> ${produto.nome} (Lote: ${produto.lote}) excedeu a quantidade máxima (${atual} > ${max})`;
                            alertasQuantidade.appendChild(alertaQuantidade);
                            produtosComProblemaQuantidade++;
                        }
                    }
                });

                if (produtosParaVencer === 0) {
                    alertasVencimento.innerHTML = "<p class='alert-item success'>✅ Nenhum produto está prestes a vencer ou vencido.</p>";
                }

                if (produtosComProblemaQuantidade === 0) {
                    alertasQuantidade.innerHTML = "<p class='alert-item success'>✅ Todos os produtos estão dentro dos limites de estoque.</p>";
                }

            } catch (error) {
                console.error("Erro ao listar produtos: ", error);
                document.getElementById("produtos-lista").innerHTML = "<li class='form-error'>Erro ao carregar produtos. Tente novamente mais tarde.</li>";
                showFeedback('general-feedback', 'Erro ao carregar produtos. Verifique sua conexão ou o servidor.', 'error');
            }
        }

        async function adicionarProduto() {
            document.getElementById("add-error-messages").innerHTML = "";
            document.getElementById("add-feedback").style.display = 'none';

            const nome = document.getElementById("nomeProduto").value.trim();
            const quantidade = document.getElementById("quantidade").value.trim();
            const validade = document.getElementById("validade").value.trim();
            const lote = document.getElementById("lote").value.trim();
            const quantidadeMinima = document.getElementById("quantidadeMinima").value.trim();
            const quantidadeMaxima = document.getElementById("quantidadeMaxima").value.trim();

            let mensagensErro = [];
            if (!nome) mensagensErro.push("Nome do produto é obrigatório.");
            if (!lote) mensagensErro.push("Lote é obrigatório.");

            if (!quantidade || isNaN(parseInt(quantidade))) {
                mensagensErro.push("Quantidade é obrigatória e deve ser um número válido.");
            } else if (parseInt(quantidade) < 0) {
                mensagensErro.push("Quantidade não pode ser negativa.");
            }

            if (!quantidadeMinima || isNaN(parseInt(quantidadeMinima))) {
                mensagensErro.push("Quantidade mínima é obrigatória e deve ser um número válido.");
            } else if (parseInt(quantidadeMinima) < 0) {
                mensagensErro.push("Quantidade mínima não pode ser negativa.");
            }

            if (!quantidadeMaxima || isNaN(parseInt(quantidadeMaxima))) {
                mensagensErro.push("Quantidade máxima é obrigatória e deve ser um número válido.");
            } else if (parseInt(quantidadeMaxima) < 0) {
                mensagensErro.push("Quantidade máxima não pode ser negativa.");
            }

            // Validação de ordem entre mínima e máxima
            if (!isNaN(parseInt(quantidadeMinima)) && !isNaN(parseInt(quantidadeMaxima))) {
                if (parseInt(quantidadeMinima) > parseInt(quantidadeMaxima)) {
                    mensagensErro.push("Quantidade mínima não pode ser maior que a quantidade máxima.");
                }
            }

            if (!validade) {
                mensagensErro.push("Data de validade é obrigatória.");
            } else {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const dataValidadeInput = new Date(validade + 'T00:00:00');
                if (dataValidadeInput < hoje) {
                    mensagensErro.push("A data de validade não pode ser no passado.");
                }
            }

            if (mensagensErro.length > 0) {
                document.getElementById("add-error-messages").innerHTML =
                    "<ul class='form-error'>" +
                    mensagensErro.map(msg => `<li>${msg}</li>`).join("") +
                    "</ul>";
                return;
            }

            const produto = {
                nome,
                quantidade: parseInt(quantidade),
                validade,
                lote,
                quantidadeMinima: parseInt(quantidadeMinima),
                quantidadeMaxima: parseInt(quantidadeMaxima)
            };

            try {
                const response = await fetch('/api/produtos/adicionar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(produto)
                });

                if (response.ok) {
                    showFeedback('add-feedback', 'Produto adicionado com sucesso!', 'success');
                    clearFormFields('add-product-form');
                    listarProdutos();
                } else {
                    // Tenta ler a mensagem de erro do backend (agora esperamos um JSON com a chave 'message')
                    const errorData = await response.json();
                    showFeedback('add-feedback', errorData.message || 'Erro desconhecido ao adicionar produto.', 'error');
                    console.error("Erro do servidor ao adicionar produto:", errorData);
                }
            } catch (error) {
                console.error("Erro ao adicionar produto: ", error);
                showFeedback('add-feedback', 'Erro de conexão ou comunicação com o servidor.', 'error');
            }
        }

        async function cadastrarSaida() {
            document.getElementById("exit-error-messages").innerHTML = "";
            document.getElementById("exit-feedback").style.display = 'none';

            const nomeProduto = document.getElementById("nomeProdutoSaida").value.trim();
            const quantidadeSaida = document.getElementById("quantidadeSaida").value.trim();
            const lote = document.getElementById("loteSaida").value.trim();

            let mensagensErro = [];
            if (!nomeProduto) mensagensErro.push("Nome do produto é obrigatório.");
            if (!lote) mensagensErro.push("Lote é obrigatório.");
            if (!quantidadeSaida || isNaN(parseInt(quantidadeSaida))) {
                mensagensErro.push("Quantidade de saída é obrigatória e deve ser um número válido.");
            } else if (parseInt(quantidadeSaida) <= 0) {
                mensagensErro.push("Quantidade de saída deve ser um número positivo.");
            }

            if (mensagensErro.length > 0) {
                document.getElementById("exit-error-messages").innerHTML =
                    "<ul class='form-error'>" +
                    mensagensErro.map(msg => `<li>${msg}</li>`).join("") +
                    "</ul>";
                return;
            }

            try {
                const response = await fetch('/api/produtos/saida', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nomeProduto, quantidadeSaida: parseInt(quantidadeSaida), lote
                    })
                });

                if (response.ok) {
                    showFeedback('exit-feedback', 'Saída registrada com sucesso!', 'success');
                    clearFormFields('exit-product-form');
                    listarProdutos();
                } else {
                    // Tenta ler a mensagem de erro do backend
                    const errorData = await response.json();
                    showFeedback('exit-feedback', errorData.message || 'Erro desconhecido ao registrar saída.', 'error');
                    console.error("Erro do servidor ao registrar saída:", errorData);
                }
            } catch (error) {
                console.error("Erro ao cadastrar saída: ", error);
                showFeedback('exit-feedback', 'Erro de conexão ou comunicação com o servidor.', 'error');
            }
        }

        // Carrega os produtos quando a página é carregada
        window.onload = function() {
            listarProdutos();
        };
    </script>
</head>
<body>
<div class="container">
    <h1>MeuEstoque - Gestão de Estoque</h1>

    <div class="form-section">
        <h2>Adicionar Produto</h2>
        <div id="add-feedback" class="form-feedback" style="display:none;"></div>
        <div id="add-error-messages"></div>
        <form id="add-product-form">
            <div class="form-group">
                <label for="nomeProduto">Nome do Produto:</label>
                <input type="text" id="nomeProduto" placeholder="Nome do Produto" required>
            </div>
            <div class="form-group">
                <label for="quantidade">Quantidade:</label>
                <input type="number" id="quantidade" placeholder="Quantidade" required min="0">
            </div>
            <div class="form-group">
                <label for="validade">Data de Validade:</label>
                <input type="date" id="validade" placeholder="Data de Validade" required>
            </div>
            <div class="form-group">
                <label for="lote">Lote:</label>
                <input type="text" id="lote" placeholder="Lote" required>
            </div>
            <div class="form-group">
                <label for="quantidadeMinima">Quantidade Mínima:</label>
                <input type="number" id="quantidadeMinima" placeholder="Quantidade Mínima" required min="0">
            </div>
            <div class="form-group">
                <label for="quantidadeMaxima">Quantidade Máxima:</label>
                <input type="number" id="quantidadeMaxima" placeholder="Quantidade Máxima" required min="0">
            </div>
            <button type="button" onclick="adicionarProduto()">Adicionar Produto</button>
        </form>
    </div>

    <div class="form-section">
        <h2>Cadastrar Saída</h2>
        <div id="exit-feedback" class="form-feedback" style="display:none;"></div>
        <div id="exit-error-messages"></div>
        <form id="exit-product-form">
            <div class="form-group">
                <label for="nomeProdutoSaida">Nome do Produto:</label>
                <input type="text" id="nomeProdutoSaida" placeholder="Nome do Produto" required>
            </div>
            <div class="form-group">
                <label for="quantidadeSaida">Quantidade de Saída:</label>
                <input type="number" id="quantidadeSaida" placeholder="Quantidade de Saída" required min="1">
            </div>
            <div class="form-group">
                <label for="loteSaida">Lote do Produto:</label>
                <input type="text" id="loteSaida" placeholder="Lote do Produto" required>
            </div>
            <button type="button" onclick="cadastrarSaida()">Cadastrar Saída</button>
        </form>
    </div>

    <div class="product-list">
        <h2>Produtos no Estoque</h2>
        <ul id="produtos-lista">
        </ul>
    </div>

    <div class="alerts">
        <div class="section">
            <h2>Alertas de Vencimento</h2>
            <div id="alertas-vencimento" class="alertas"></div>
        </div>
        <div class="section">
            <h2>Alertas de Quantidade</h2>
            <div id="alertas-quantidade" class="alertas"></div>
        </div>
    </div>
    <div id="general-feedback" class="form-feedback" style="display:none;"></div>
</div>
</body>
</html>